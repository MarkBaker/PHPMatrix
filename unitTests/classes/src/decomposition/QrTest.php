<?php

namespace Matrix\Test;

use Matrix\Decomposition\QR;
use Matrix\Matrix as Matrix;

class QrTest extends BaseTestAbstract
{
    public function testBasicQRDecomposition()
    {
        $grid = [
            [1, -2],
            [-3, 4]
        ];

        $matrix = new Matrix($grid);
        $decomposition = new QR($matrix);

        // Verify that the original matrix remains unchanged
        $this->assertOriginalMatrixIsUnchanged($grid, $matrix);
    }

    /**
     * @dataProvider dataProvider
     */
    public function testQRDecompositionQ($expected, $grid)
    {
        $matrix = new Matrix($grid);
        $decomposition = new QR($matrix);

        $Q = $decomposition->getQ();
        //    Must return an object of the correct type...
        $this->assertIsMatrixObject($Q);
        //    ... containing the correct data
        $this->assertMatrixValues($Q, count($expected['Q']), count($expected['Q'][0]), $expected['Q']);
    }

    /**
     * @dataProvider dataProvider
     */
    public function testQRDecompositionR($expected, $grid)
    {
        $matrix = new Matrix($grid);
        $decomposition = new QR($matrix);

        $R = $decomposition->getR();
        //    Must return an object of the correct type...
        $this->assertIsMatrixObject($R);
        //    ... containing the correct data
        $this->assertMatrixValues($R, count($expected['R']), count($expected['R'][0]), $expected['R']);
    }

    public function dataProvider()
    {
        return [
            'Simple 3x3 Matrix' => [
                [
                    'Q' => [
                        [-0.123091490979333, 0.904534033733291, 0.408248290463862],
                        [-0.492365963917331,  0.301511344577763, -0.816496580927726],
                        [-0.861640436855329, -0.301511344577763, 0.408248290463863]
                    ],
                    'R' => [
                        [-8.124038404635960, -9.601136296387950, -11.078234188139900],
                        [0.0, 0.904534033733293, 1.809068067466580],
                        [0.0, 0.0, -0.000000000000001]
                    ],
                ],
                [
                    [1, 2, 3],
                    [4, 5, 6],
                    [7, 8, 9]
                ],
            ],
            '3x3 Magic Square' => [
                [
                    'Q' => [
                        [-0.199007438041998, 0.972488642858958, -0.121086246594330],
                        [-0.895533471188990, -0.230643324147080, -0.380556775010750],
                        [-0.398014876083996, 0.032703157901452, 0.916795867071353]
                    ],
                    'R' => [
                        [-10.049875621120900, -7.064764050490930, -5.273697108112940],
                        [0.0, 5.752313352981660, 5.865913796218280],
                        [0.0, 0.0, 6.227292681994100]
                    ],
                ],
                [
                    [2, 7, 6],
                    [9, 5, 1],
                    [4, 3, 8]
                ],
            ],
            'Another Simple 3x3' => [
                [
                    'Q' => [
                        [-0.408248290463863, 0.707106781186548, 0.577350269189626],
                        [-0.816496580927726, 0.0, -0.577350269189626],
                        [-0.408248290463863, -0.707106781186547, 0.577350269189626]
                    ],
                    'R' => [
                        [-2.449489742783180, -4.898979485566360, -7.756717518813400],
                        [0.0, 1.414213562373100, 3.535533905932740],
                        [0.0, 0.0, -1.154700538379250]
                    ],
                ],
                [
                    [1, 3, 5],
                    [2, 4, 7],
                    [1, 1, 0]
                ],
            ],
            '4x4 with positive and negative values' => [
                [
                    'Q' => [
                        [-0.294883912309794, 0.646908108895345, 0.655396891228784, 0.254967236863805],
                        [0.147441956154897, -0.323454054447673, 0.647746343860355, -0.673841983140056],
                        [-0.589767824619589, 0.344100057923056, -0.357025543860038, -0.637418092159512],
                        [-0.737209780774486, -0.598734100786117, 0.153010947368588, 0.273179182354076]
                    ],
                    'R' => [
                        [-6.782329983125270, 0.294883912309793, 3.980932816182220, -2.211629342323460],
                        [0.0, 6.317677063467310, 0.763902128589184, -2.112774355647560],
                        [0.0, 0.0, 2.562933368423840, -1.007322070176540],
                        [0.0, 0.0, 0.0, -6.374180921595120]
                    ],
                ],
                [
                    [2, 4, 1, -3],
                    [-1, -2, 2, 4],
                    [4, 2, -3, 5],
                    [5, -4, -3, 1]
                ],
            ],
            '4x4 with positive and negative float values' => [
                [
                    'Q' => [
                        [-0.870388279778489, -0.225482237707286, 0.265273220832105, 0.348155311911392],
                        [-0.348155311911396, -0.265273220832101, -0.225482237707296, -0.870388279778486],
                        [0.0, -0.437700814372966, -0.828978815100310, 0.348155311911405],
                        [0.348155311911396, -0.828978815100314, 0.437700814372966, -0.000000000000005]
                    ],
                    'R' => [
                        [2.872281323269010, 1.740776559556980, 1.392621247645580, 2.437087183379770],
                        [0.0, -2.284665614416470, -5.504419332266090, -13.024915142856100],
                        [0.0, 0.0, -0.109425203593242, 0.809083323537904],
                        [0.0, 0.0, 0.0, -0.087038827977862]
                    ],
                ],
                [
                    [-2.5, -1, 0, 1],
                    [-1, 0, 1, 2.5],
                    [0, 1, 2.5, 5],
                    [1, 2.5, 5, 12]
                ],
            ],
            '4x4 Magic square' =>[
                [
                    'Q' => [
                        [-0.486664263392288, -0.025409618431111, 0.793825739600044, 0.363803437554500],
                        [-0.216295228174350, -0.755583236958464, 0.121092061972888, -0.606339062590832],
                        [-0.757033298610225, 0.463372625000684, -0.282548144603405, -0.363803437554500],
                        [-0.378516649305113, -0.462313890899387, -0.524732268549182, 0.606339062590832]
                    ],
                    'R' => [
                        [-18.493242008906900, -11.463647093240600, -14.599927901768600, -17.952503938471100],
                        [0.0, -16.570600330755600, -9.935160806564540, -0.011998986481357],
                        [0.0, 0.0, -5.489506809437590, 9.149178015729320],
                        [0.0, 0.0, 0.0, 0.0]
                    ],
                ],
                [
                    [9, 6, 3, 16],
                    [4, 15, 10, 5],
                    [14, 1, 8, 11],
                    [7, 12, 13, 2]
                ],
            ],
            'Asymetric - 2 rows 3 columns' => [
                [
                    'Q' => [
                        [-0.242535625036333, -0.970142500145332],
                        [-0.970142500145332, 0.242535625036333]
                    ],
                    'R' => [
                        [-4.123105625617660, -5.335783750799330, -6.548461875980990],
                        [0.0, -0.727606875108999, -1.455213750218000]
                    ],
                ],
                [
                    [1, 2, 3],
                    [4, 5, 6]
                ],
            ],
            'Asymetric - 3 rows 2 columns' => [
                [
                    'Q' => [
                        [-0.169030850945703, 0.897085227145060],
                        [-0.507092552837110, 0.276026223736942],
                        [-0.845154254728517, -0.345032779671177]
                    ],
                    'R' => [
                        [-5.916079783099620, -7.437357441610940],
                        [0.0, 0.828078671210823]
                    ],
                ],
                [
                    [1, 2],
                    [3, 4],
                    [5, 6]
                ],
            ],
        ];
    }
}
